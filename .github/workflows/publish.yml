name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to Test PyPI instead of production'
        required: false
        type: boolean
        default: true

jobs:
  build-libraries:
    name: Build FAEST libraries for all platforms
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          - os: macos-latest
            platform: macos
            arch: arm64
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install build dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build
    
    - name: Install build dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install meson ninja
    
    - name: Clone faest-ref
      run: |
        git clone --depth=1 https://github.com/faest-sign/faest-ref.git
    
    - name: Build FAEST library
      timeout-minutes: 20
      run: |
        cd faest-ref
        meson setup build
        meson compile -C build
    
    - name: Prepare libraries (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p lib/${{ matrix.platform }}/${{ matrix.arch }}
        find faest-ref/build -name "libfaest.so*" -type f -exec cp {} lib/${{ matrix.platform }}/${{ matrix.arch }}/ \;
        cd lib/${{ matrix.platform }}/${{ matrix.arch }}
        # Create full symlink chain: libfaest.so -> libfaest.so.1 -> libfaest.so.1.0.0
        ln -sf libfaest.so.1.0.0 libfaest.so.1
        ln -sf libfaest.so.1 libfaest.so
        ls -lh
    
    - name: Prepare libraries (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        mkdir -p lib/${{ matrix.platform }}/${{ matrix.arch }}
        find faest-ref/build -name "libfaest*.dylib" -type f -exec cp {} lib/${{ matrix.platform }}/${{ matrix.arch }}/ \;
        cd lib/${{ matrix.platform }}/${{ matrix.arch }}
        # Create symlink chain for macOS
        ln -sf libfaest.1.dylib libfaest.dylib
        ls -lh
    
    - name: Prepare headers
      run: |
        mkdir -p include
        cp faest-ref/*.h include/ || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: faest-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          lib/
          include/

  build-wheels:
    name: Build wheels for ${{ matrix.platform }} Python ${{ matrix.python-version }}
    needs: build-libraries
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.7'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.8'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.9'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.10'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.11'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.12'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.13'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.14-dev'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.7'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.8'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.9'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.10'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.11'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.12'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.13'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.14-dev'
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set macOS deployment target
      if: matrix.os == 'macos-latest'
      run: |
        echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          pip install auditwheel patchelf
        fi

    - name: Download library artifacts
      uses: actions/download-artifact@v4
      with:
        name: faest-${{ matrix.platform }}-${{ matrix.arch }}

    - name: Add __init__.py files to make packages
      run: |
        echo "# Library package" > lib/__init__.py
        find lib -type d -exec sh -c 'echo "# Platform package" > "{}/__init__.py"' \;
        echo "# Include package" > include/__init__.py

    - name: Build wheel
      run: |
        python setup.py bdist_wheel

    - name: Repair wheel (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        auditwheel repair dist/*.whl -w dist/ --plat manylinux_2_17_x86_64 || echo "auditwheel failed, keeping original"
        rm -f dist/*-linux_x86_64.whl

    - name: Upload wheel
      uses: actions/upload-artifact@v4
      with:
        name: wheel-${{ matrix.platform }}-${{ matrix.arch }}-py${{ matrix.python-version }}
        path: dist/*.whl

  publish:
    name: Publish to PyPI
    needs: [build-libraries, build-wheels]
    runs-on: ubuntu-latest
    environment: release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install twine wheel

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Show downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find artifacts -type f
        ls -la artifacts/
    
    - name: Combine libraries for sdist
      run: |
        mkdir -p lib include
        
        # Copy Linux libraries
        if [ -d "artifacts/faest-linux-x86_64/lib" ]; then
          cp -rv artifacts/faest-linux-x86_64/lib/* lib/
        fi
        
        # Copy macOS libraries
        if [ -d "artifacts/faest-macos-arm64/lib" ]; then
          cp -rv artifacts/faest-macos-arm64/lib/* lib/
        fi
        
        # Copy headers from any artifact (should be same)
        if [ -d "artifacts/faest-linux-x86_64/include" ]; then
          cp -rv artifacts/faest-linux-x86_64/include/* include/
        elif [ -d "artifacts/faest-macos-arm64/include" ]; then
          cp -rv artifacts/faest-macos-arm64/include/* include/
        fi
        
        # Show what we have
        echo "Combined libraries:"
        find lib -type f

    - name: Add __init__.py files to make packages
      run: |
        echo "# Library package" > lib/__init__.py
        find lib -type d -exec sh -c 'echo "# Platform package" > "{}/__init__.py"' \;
        echo "# Include package" > include/__init__.py

    - name: Verify library structure before building
      run: |
        echo "Library structure:"
        find lib -type f -name "*.so*" -o -name "*.dylib"
        echo "Headers:"
        ls include/*.h | head -5 || echo "No headers found"
        echo "All lib contents:"
        ls -laR lib/
        echo "All include contents:"
        ls -la include/
        
        # Ensure we have at least Linux libraries
        if [ ! -f lib/linux/x86_64/libfaest.so.1.0.0 ]; then
          echo "ERROR: Linux libraries not found!"
          exit 1
        fi

    - name: Clean dist directory
      run: |
        rm -rf dist/ build/ *.egg-info

    - name: Build source distribution
      run: |
        echo "# Library package" > lib/__init__.py
        find lib -type d -exec sh -c 'echo "# Platform package" > "{}/__init__.py"' \;
        echo "# Include package" > include/__init__.py
        python setup.py sdist
        
    - name: Copy wheels to dist
      run: |
        mkdir -p dist
        find artifacts -name "*.whl" -exec cp {} dist/ \;
        ls -lh dist/
        
    - name: Verify tarball contents
      run: |
        echo "Checking tarball contents:"
        tar -tzf dist/*.tar.gz | grep -E '(lib/|include/)' || echo "WARNING: No lib or include files in tarball!"

    - name: Check distribution
      run: |
        twine check dist/*
        echo "Built distributions:"
        ls -lh dist/
        echo ""
        echo "Tarball contents (sample):"
        tar -tzf dist/*.tar.gz | grep -E '(lib/|include/)' | head -10

    - name: Publish to Test PyPI
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        twine upload --repository testpypi dist/*

    - name: Publish to PyPI
      if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi != 'true')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: distribution-${{ github.ref_name }}
        path: dist/
