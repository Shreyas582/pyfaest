name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to Test PyPI instead of production'
        required: false
        type: boolean
        default: true

jobs:
  build-libraries:
    name: Build FAEST libraries for all platforms
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (native build)
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            cross_compile: false
          # Linux aarch64 (cross-compile)
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            cross_compile: true
          # macOS arm64 (Apple Silicon - native)
          - os: macos-latest
            platform: macos
            arch: arm64
            cross_compile: false
          # macOS x86_64 (Intel - cross-compile from arm64)
          - os: macos-latest
            platform: macos
            arch: x86_64
            cross_compile: true
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install build dependencies (Linux x86_64)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'x86_64'
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build

    - name: Install build dependencies (Linux aarch64 cross-compile)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
    
    - name: Install build dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install meson ninja
    
    - name: Clone faest-ref
      run: |
        git clone --depth=1 https://github.com/faest-sign/faest-ref.git

    - name: Build FAEST library (Linux x86_64)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'x86_64'
      timeout-minutes: 20
      run: |
        cd faest-ref
        meson setup build
        meson compile -C build

    - name: Build FAEST library (Linux aarch64 cross-compile)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
      timeout-minutes: 30
      run: |
        cd faest-ref
        # Create cross-compilation file for aarch64
        cat > aarch64-cross.txt << 'EOF'
        [binaries]
        c = 'aarch64-linux-gnu-gcc'
        cpp = 'aarch64-linux-gnu-g++'
        ar = 'aarch64-linux-gnu-ar'
        strip = 'aarch64-linux-gnu-strip'
        pkg-config = 'aarch64-linux-gnu-pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF
        # Build without OpenSSL (SHAKE-based randomness is fine for FAEST)
        meson setup build --cross-file=aarch64-cross.txt -Dopenssl=disabled
        meson compile -C build

    - name: Build FAEST library (macOS arm64)
      if: matrix.os == 'macos-latest' && matrix.arch == 'arm64'
      timeout-minutes: 20
      run: |
        cd faest-ref
        meson setup build
        meson compile -C build

    - name: Build FAEST library (macOS x86_64 cross-compile)
      if: matrix.os == 'macos-latest' && matrix.arch == 'x86_64'
      timeout-minutes: 30
      run: |
        cd faest-ref
        # Create cross-compilation file for x86_64
        cat > x86_64-cross.txt << 'EOF'
        [binaries]
        c = 'clang'
        cpp = 'clang++'
        
        [built-in options]
        c_args = ['-arch', 'x86_64', '-mmacosx-version-min=10.14']
        cpp_args = ['-arch', 'x86_64', '-mmacosx-version-min=10.14']
        c_link_args = ['-arch', 'x86_64', '-mmacosx-version-min=10.14']
        cpp_link_args = ['-arch', 'x86_64', '-mmacosx-version-min=10.14']
        
        [host_machine]
        system = 'darwin'
        cpu_family = 'x86_64'
        cpu = 'x86_64'
        endian = 'little'
        EOF
        meson setup build --cross-file=x86_64-cross.txt
        meson compile -C build
    
    - name: Prepare libraries (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p lib/${{ matrix.platform }}/${{ matrix.arch }}
        find faest-ref/build -name "libfaest.so*" -type f -exec cp {} lib/${{ matrix.platform }}/${{ matrix.arch }}/ \;
        cd lib/${{ matrix.platform }}/${{ matrix.arch }}
        # Create full symlink chain: libfaest.so -> libfaest.so.1 -> libfaest.so.1.0.0
        ln -sf libfaest.so.1.0.0 libfaest.so.1
        ln -sf libfaest.so.1 libfaest.so
        ls -lh
    
    - name: Prepare libraries (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        mkdir -p lib/${{ matrix.platform }}/${{ matrix.arch }}
        find faest-ref/build -name "libfaest*.dylib" -type f -exec cp {} lib/${{ matrix.platform }}/${{ matrix.arch }}/ \;
        cd lib/${{ matrix.platform }}/${{ matrix.arch }}
        # Create symlink chain for macOS
        ln -sf libfaest.1.dylib libfaest.dylib
        ls -lh
    
    - name: Prepare headers
      run: |
        mkdir -p include
        cp faest-ref/*.h include/ || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: faest-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          lib/
          include/

  build-wheels:
    name: Build wheels for ${{ matrix.platform }}-${{ matrix.arch }} Python ${{ matrix.python-version }}
    needs: build-libraries
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.8'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.9'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.10'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.11'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.12'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.13'
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.14-dev'
          # Linux aarch64 (ARM64)
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.8'
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.9'
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.10'
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.11'
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.12'
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.13'
          - os: ubuntu-latest
            platform: linux
            arch: aarch64
            python-version: '3.14-dev'
          # macOS arm64 (Apple Silicon)
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.8'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.9'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.10'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.11'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.12'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.13'
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.14-dev'
          # macOS x86_64 (Intel Macs) - using macos-15 with cross-compiled library
          - os: macos-15
            platform: macos
            arch: x86_64
            python-version: '3.8'
          - os: macos-15
            platform: macos
            arch: x86_64
            python-version: '3.9'
          - os: macos-15
            platform: macos
            arch: x86_64
            python-version: '3.10'
          - os: macos-15
            platform: macos
            arch: x86_64
            python-version: '3.11'
          - os: macos-15
            platform: macos
            arch: x86_64
            python-version: '3.12'
          - os: macos-15
            platform: macos
            arch: x86_64
            python-version: '3.13'
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set macOS deployment target
      if: matrix.platform == 'macos'
      run: |
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
        else
          echo "MACOSX_DEPLOYMENT_TARGET=10.14" >> $GITHUB_ENV
        fi

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools cffi pycparser
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          pip install auditwheel patchelf
        fi

    - name: Download library artifacts
      uses: actions/download-artifact@v4
      with:
        name: faest-${{ matrix.platform }}-${{ matrix.arch }}

    - name: Add __init__.py files to make packages
      run: |
        echo "# Library package" > lib/__init__.py
        find lib -type d -exec sh -c 'echo "# Platform package" > "{}/__init__.py"' \;
        echo "# Include package" > include/__init__.py

    - name: Build wheel
      run: |
        pip wheel . --no-deps -w dist/

    - name: Rename macOS x86_64 wheel to correct platform tag
      if: matrix.platform == 'macos' && matrix.arch == 'x86_64'
      run: |
        # The wheel built on arm64 will have arm64 tag, rename it for x86_64
        cd dist
        for f in *macosx*arm64*.whl; do
          if [ -f "$f" ]; then
            newname=$(echo "$f" | sed 's/arm64/x86_64/g' | sed 's/macosx_11_0/macosx_10_14/g')
            mv "$f" "$newname"
            echo "Renamed $f to $newname"
          fi
        done
        ls -la

    - name: Repair wheel (Linux x86_64)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'x86_64'
      run: |
        auditwheel repair dist/*.whl -w dist/ --plat manylinux_2_17_x86_64 || echo "auditwheel failed, keeping original"
        rm -f dist/*-linux_x86_64.whl

    - name: Repair wheel (Linux aarch64)
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
      run: |
        auditwheel repair dist/*.whl -w dist/ --plat manylinux_2_17_aarch64 || echo "auditwheel failed, keeping original"
        rm -f dist/*-linux_aarch64.whl

    - name: Upload wheel
      uses: actions/upload-artifact@v4
      with:
        name: wheel-${{ matrix.platform }}-${{ matrix.arch }}-py${{ matrix.python-version }}
        path: dist/*.whl

  publish:
    name: Publish to PyPI
    needs: [build-libraries, build-wheels]
    runs-on: ubuntu-latest
    environment: release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install twine wheel

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Show downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find artifacts -type f
        ls -la artifacts/
    
    - name: Combine libraries for sdist
      run: |
        mkdir -p lib include
        
        # Copy Linux x86_64 libraries
        if [ -d "artifacts/faest-linux-x86_64/lib" ]; then
          cp -rv artifacts/faest-linux-x86_64/lib/* lib/
        fi
        
        # Copy Linux aarch64 libraries
        if [ -d "artifacts/faest-linux-aarch64/lib" ]; then
          cp -rv artifacts/faest-linux-aarch64/lib/* lib/
        fi
        
        # Copy macOS arm64 libraries
        if [ -d "artifacts/faest-macos-arm64/lib" ]; then
          cp -rv artifacts/faest-macos-arm64/lib/* lib/
        fi
        
        # Copy macOS x86_64 libraries
        if [ -d "artifacts/faest-macos-x86_64/lib" ]; then
          cp -rv artifacts/faest-macos-x86_64/lib/* lib/
        fi
        
        # Copy headers from any artifact (should be same)
        if [ -d "artifacts/faest-linux-x86_64/include" ]; then
          cp -rv artifacts/faest-linux-x86_64/include/* include/
        elif [ -d "artifacts/faest-macos-arm64/include" ]; then
          cp -rv artifacts/faest-macos-arm64/include/* include/
        fi
        
        # Show what we have
        echo "Combined libraries:"
        find lib -type f

    - name: Add __init__.py files to make packages
      run: |
        echo "# Library package" > lib/__init__.py
        find lib -type d -exec sh -c 'echo "# Platform package" > "{}/__init__.py"' \;
        echo "# Include package" > include/__init__.py

    - name: Verify library structure before building
      run: |
        echo "Library structure:"
        find lib -type f -name "*.so*" -o -name "*.dylib"
        echo "Headers:"
        ls include/*.h | head -5 || echo "No headers found"
        echo "All lib contents:"
        ls -laR lib/
        echo "All include contents:"
        ls -la include/
        
        # Ensure we have at least Linux libraries
        if [ ! -f lib/linux/x86_64/libfaest.so.1.0.0 ]; then
          echo "ERROR: Linux libraries not found!"
          exit 1
        fi

    - name: Clean dist directory
      run: |
        rm -rf dist/ build/ *.egg-info

    - name: Build source distribution
      run: |
        echo "# Library package" > lib/__init__.py
        find lib -type d -exec sh -c 'echo "# Platform package" > "{}/__init__.py"' \;
        echo "# Include package" > include/__init__.py
        python setup.py sdist
        
    - name: Copy wheels to dist
      run: |
        mkdir -p dist
        find artifacts -name "*.whl" -exec cp {} dist/ \;
        ls -lh dist/
        
    - name: Verify tarball contents
      run: |
        echo "Checking tarball contents:"
        tar -tzf dist/*.tar.gz | grep -E '(lib/|include/)' || echo "WARNING: No lib or include files in tarball!"

    - name: Check distribution
      run: |
        twine check dist/*
        echo "Built distributions:"
        ls -lh dist/
        echo ""
        echo "Tarball contents (sample):"
        tar -tzf dist/*.tar.gz | grep -E '(lib/|include/)' | head -10

    - name: Publish to Test PyPI
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        twine upload --repository testpypi dist/*

    - name: Publish to PyPI
      if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi != 'true')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: distribution-${{ github.ref_name }}
        path: dist/
