name: Build FAEST Libraries

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    name: Build for Linux (x86_64)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout pyfaest
      uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build
    
    - name: Clone faest-ref
      run: |
        git clone --depth=1 https://github.com/faest-sign/faest-ref.git
    
    - name: Build FAEST library
      run: |
        cd faest-ref
        meson setup build
        meson compile -C build
    
    - name: Prepare bundled libraries
      run: |
        mkdir -p lib/linux/x86_64
        mkdir -p include
        cp faest-ref/build/libfaest.so* lib/linux/x86_64/ || true
        cp faest-ref/*.h include/ || true
        ls -lh lib/linux/x86_64/
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: faest-linux-x86_64
        path: |
          lib/linux/x86_64/
          include/

  build-macos:
    name: Build for macOS (x86_64 & arm64)
    runs-on: macos-latest
    
    steps:
    - name: Checkout pyfaest
      uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        brew install meson ninja
    
    - name: Clone faest-ref
      run: |
        git clone --depth=1 https://github.com/faest-sign/faest-ref.git
    
    - name: Build FAEST library (Universal Binary)
      run: |
        cd faest-ref
        meson setup build
        meson compile -C build
    
    - name: Prepare bundled libraries
      run: |
        mkdir -p lib/macos/arm64
        mkdir -p lib/macos/x86_64
        mkdir -p include
        cp faest-ref/build/libfaest.dylib lib/macos/arm64/ || true
        cp faest-ref/build/libfaest.dylib lib/macos/x86_64/ || true
        cp faest-ref/*.h include/ || true
        ls -lh lib/macos/*/
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: faest-macos
        path: |
          lib/macos/
          include/

  build-windows:
    name: Build for Windows (x64)
    runs-on: windows-latest
    
    steps:
    - name: Checkout pyfaest
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install build dependencies
      run: |
        pip install meson ninja
    
    - name: Install Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Clone faest-ref
      run: |
        git clone --depth=1 https://github.com/faest-sign/faest-ref.git
    
    - name: Build FAEST library
      run: |
        cd faest-ref
        meson setup build
        meson compile -C build
      shell: cmd
    
    - name: Prepare bundled libraries
      run: |
        mkdir -p lib/windows/x64
        mkdir -p include
        cp faest-ref/build/faest.dll lib/windows/x64/ 2>$null || echo "DLL not found"
        cp faest-ref/build/libfaest.dll lib/windows/x64/ 2>$null || echo "libfaest.dll not found"
        cp faest-ref/*.h include/ 2>$null || echo "Headers not found"
        ls lib/windows/x64/
      shell: pwsh
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: faest-windows-x64
        path: |
          lib/windows/x64/
          include/

  combine-artifacts:
    name: Combine all platform libraries
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Combine artifacts
      run: |
        mkdir -p combined/lib
        mkdir -p combined/include
        
        # Copy Linux libraries
        if [ -d "artifacts/faest-linux-x86_64/lib" ]; then
          cp -r artifacts/faest-linux-x86_64/lib/* combined/lib/
        fi
        
        # Copy macOS libraries
        if [ -d "artifacts/faest-macos/lib" ]; then
          cp -r artifacts/faest-macos/lib/* combined/lib/
        fi
        
        # Copy Windows libraries
        if [ -d "artifacts/faest-windows-x64/lib" ]; then
          cp -r artifacts/faest-windows-x64/lib/* combined/lib/
        fi
        
        # Copy headers (from any artifact, they should be the same)
        if [ -d "artifacts/faest-linux-x86_64/include" ]; then
          cp -r artifacts/faest-linux-x86_64/include/* combined/include/
        fi
        
        # Show what we have
        find combined -type f
    
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v4
      with:
        name: faest-all-platforms
        path: combined/
        retention-days: 30
